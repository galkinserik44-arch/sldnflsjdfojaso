<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TURRET CHESS v13.5 - STABLE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #lobby { background: #000; padding: 30px; border-radius: 15px; text-align: center; border: 2px solid #4caf50; width: 280px; }
        #game-ui { display: none; flex-direction: column; align-items: center; }
        #board { display: grid; grid-template-columns: repeat(8, 11vw); grid-template-rows: repeat(8, 11vw); background: #444; border: 2px solid #333; max-width: 480px; max-height: 480px; }
        @media (min-width: 500px) { #board { grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); } .cell { width: 60px !important; height: 60px !important; } }
        .cell { width: 11vw; height: 11vw; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; position: relative; }
        .white-cell { background: #eeeed2; color: #333; }
        .black-cell { background: #769656; color: #fff; }
        .piece-white { color: #fff; text-shadow: 1px 1px #000; }
        .piece-black { color: #000; text-shadow: 0px 0px 1px #fff; }
        .selected { background: #f6f669 !important; }
        .valid-move::after { content: ''; width: 12px; height: 12px; background: rgba(0,0,0,0.2); border-radius: 50%; position: absolute; }
        .valid-shoot { background: #ff5252 !important; }
        .hp-bar { position: absolute; top: 1px; left: 2px; right: 2px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .hp-fill { height: 100%; background: #0f0; }
        .btn { background: #4caf50; border: none; color: white; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 8px; width: 100%; text-transform: uppercase; margin-top: 10px; }
        #status-bar { margin-bottom: 10px; font-weight: bold; }
        #debug { font-size: 10px; color: #666; margin-top: 15px; height: 20px; }
    </style>
</head>
<body>
    <div id="lobby">
        <h2 style="margin:0">TURRET CHESS</h2>
        <div id="lobby-status" style="font-size:12px; margin:10px 0; color:#ffeb3b">Запуск...</div>
        <div id="id-box" style="display:none">
            <div id="my-id" style="font-weight:bold; font-size:18px; color:#4caf50; background:#222; padding:10px; margin:10px 0; border-radius:5px;">----</div>
            <button class="btn" style="background:#ff9800" onclick="copyInvite()">СКОПИРОВАТЬ ССЫЛКУ</button>
            <p style="font-size:10px; color:#555">Или введи ID друга ниже:</p>
            <input type="text" id="target-id" placeholder="ID друга" style="padding:10px; width:80%; text-align:center; background:#333; color:#fff; border:none; border-radius:5px;">
            <button class="btn" style="background:#2196f3" onclick="joinRoom()">ПОДКЛЮЧИТЬСЯ</button>
        </div>
        <div id="debug"></div>
    </div>

    <div id="game-ui">
        <div id="status-bar">Ход белых</div>
        <div id="board" oncontextmenu="return false;"></div>
        <div style="margin-top:10px; font-size:10px; color:#666">ЛКМ: Ход+Стрелять | ПКМ: Только стрелять</div>
    </div>

    <script>
        const stats = { p:{hp:2,d:1}, r:{hp:7,d:3}, n:{hp:4,d:2}, b:{hp:4,d:2}, q:{hp:10,d:3}, k:{hp:15,d:1} };
        let board=[], sel=null, moves=[], shoots=[], turn='white', myCol=null, peer, conn;

        function log(m) { document.getElementById('debug').innerText = m; }

        function init() {
            peer = new Peer({ config: {'iceServers': [
                {urls:'stun:stun.l.google.com:19302'}, {urls:'stun:stun1.l.google.com:19302'},
                {urls:'stun:stun2.l.google.com:19302'}, {urls:'stun:stun.services.mozilla.com'}
            ]}});
            peer.on('open', id => {
                document.getElementById('lobby-status').innerText = "Сеть готова";
                document.getElementById('my-id').innerText = id;
                document.getElementById('id-box').style.display = 'block';
                const urlId = new URLSearchParams(window.location.search).get('join');
                if (urlId) { document.getElementById('target-id').value = urlId; joinRoom(); }
            });
            peer.on('connection', c => {
                conn = c; myCol = 'white'; setupConn(); log("Друг вошел!"); start();
            });
        }

        function joinRoom() {
            const id = document.getElementById('target-id').value.trim();
            if(!id) return;
            log("Подключение...");
            conn = peer.connect(id, {reliable:false});
            myCol = 'black';
            conn.on('open', () => { setupConn(); log("Успех!"); start(); });
        }

        function setupConn() {
            conn.on('data', d => {
                if(d.type==='sync') { board=d.board; turn=d.turn; render(); }
            });
        }

        function start() {
            document.getElementById('lobby').style.display='none';
            document.getElementById('game-ui').style.display='flex';
            if(board.length===0) initBoard();
            render();
            if(myCol==='white') sync();
        }

        function initBoard() {
            board = Array(8).fill().map(() => Array(8).fill(null));
            for(let i=0;i<8;i++) { board[1][i]={t:'p',c:'black',hp:2,m:0}; board[6][i]={t:'p',c:'white',hp:2,m:0}; }
            const l=['r','n','b','q','k','b','n','r'];
            l.forEach((p,i)=>{ board[0][i]={t:p,c:'black',hp:stats[p].hp,m:0}; board[7][i]={t:p,c:'white',hp:stats[p].hp,m:0}; });
        }

        function render() {
            const el = document.getElementById('board'); el.innerHTML = '';
            const rIdx = myCol==='black' ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
            const cIdx = myCol==='black' ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
            for(let r of rIdx) {
                for(let c of cIdx) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(r+c)%2===0?'white-cell':'black-cell'}`;
                    const p = board[r][c];
                    if(p) {
                        cell.innerText = {white:{p:'♙',r:'♖',n:'♘',b:'♗',q:'♕',k:'♔'},black:{p:'♟',r:'♜',n:'♞',b:'♝',q:'♛',k:'♚' }}[p.c][p.t];
                        cell.classList.add('piece-'+p.c);
                        const hb = document.createElement('div'); hb.className='hp-bar';
                        const hf = document.createElement('div'); hf.className='hp-fill';
                        hf.style.width = (p.hp/stats[p.t].hp*100)+'%';
                        hb.appendChild(hf); cell.appendChild(hb);
                    }
                    cell.onmousedown = (e) => handleClick(r,c,e);
                    if(sel && sel.r===r && sel.c===c) cell.classList.add('selected');
                    if(moves.some(m=>m.r===r&&m.c===c)) cell.classList.add('valid-move');
                    if(shoots.some(m=>m.r===r&&m.c===c)) cell.classList.add('valid-shoot');
                    el.appendChild(cell);
                }
            }
            document.getElementById('status-bar').innerText = turn===myCol ? "ТВОЙ ХОД" : "ХОД ВРАГА";
        }

        function handleClick(r,c,e) {
            if(turn!==myCol) return;
            const p = board[r][c];
            if(!sel) {
                if(p && p.c===turn) {
                    sel={r,c};
                    if(e.button===0) { moves=getMoves(r,c,false); shoots=[]; }
                    else { shoots=getMoves(r,c,true); moves=[]; }
                }
            } else {
                const move = moves.find(m=>m.r===r&&m.c===c);
                const shoot = shoots.find(s=>s.r===r&&s.c===c);
                if(move) {
                    board[r][c] = {...board[sel.r][sel.c], m:1}; board[sel.r][sel.c]=null;
                    sel={r,c}; moves=[]; shoots=getMoves(r,c,true);
                    if(shoots.length===0) end();
                } else if(shoot) {
                    board[r][c].hp -= stats[board[sel.r][sel.c].t].d;
                    if(board[r][c].hp<=0) board[r][c]=null;
                    end();
                } else { sel=null; moves=[]; shoots=[]; }
            }
            render();
        }

        function getMoves(r,c,isS) {
            let res=[]; const p=board[r][c], d=p.c==='white'?-1:1;
            if(p.t==='p') {
                if(!isS) {
                    if(board[r+d] && !board[r+d][c]) { res.push({r:r+d,c}); if(!p.m && board[r+2*d] && !board[r+2*d][c]) res.push({r:r+2*d,c}); }
                    [[d,1],[d,-1]].forEach(v=>{ let nr=r+v[0], nc=c+v[1]; if(board[nr]&&board[nr][nc]&&board[nr][nc].c!==p.c&&board[nr][nc].t!=='k') res.push({r:nr,c:nc}); });
                } else [[d,1],[d,-1]].forEach(v=>{ let nr=r+v[0], nc=c+v[1]; if(board[nr]&&board[nr][nc]&&board[nr][nc].c!==p.c) res.push({r:nr,c:nc}); });
            } else if(p.t==='n') {
                [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(v=>{
                    let nr=r+v[0], nc=c+v[1]; if(board[nr] && board[nr][nc]!==undefined) {
                        if(!board[nr][nc] || (board[nr][nc].c!==p.c && (isS || board[nr][nc].t!=='k'))) res.push({r:nr,c:nc});
                    }
                });
            } else {
                const dirs = p.t==='r' ? [[0,1],[0,-1],[1,0],[-1,0]] : p.t==='b' ? [[1,1],[1,-1],[-1,1],[-1,-1]] : [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];
                dirs.forEach(v=>{
                    for(let i=1;i<8;i++){
                        let nr=r+v[0]*i, nc=c+v[1]*i; if(nr<0||nr>=8||nc<0||nc>=8)break;
                        if(!board[nr][nc]) { if(!isS) res.push({r:nr,c:nc}); }
                        else { if(board[nr][nc].c!==p.c && (isS||board[nr][nc].t!=='k')) res.push({r:nr,c:nc}); break; }
                    }
                });
            }
            return res;
        }

        function end() { turn=turn==='white'?'black':'white'; sel=null; moves=[]; shoots=[]; sync(); }
        function sync() { if(conn && conn.open) conn.send({type:'sync', board, turn}); }
        function copyInvite() {
            const url = window.location.origin + window.location.pathname + "?join=" + document.getElementById('my-id').innerText;
            navigator.clipboard.writeText(url); alert("Ссылка скопирована!");
        }

        init();
    </script>
</body>
</html>